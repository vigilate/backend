#!/bin/python3

import pprint
import argparse
import xml.etree.ElementTree as etree
from dateutil.parser import parse as parse_date

class CveXmlParser():

    NS = {"scap-core": "http://scap.nist.gov/schema/scap-core/0.1",
          "cvss": "http://scap.nist.gov/schema/cvss-v2/0.2",
          "vuln": "http://scap.nist.gov/schema/vulnerability/0.4",
          "xsi": "http://www.w3.org/2001/XMLSchema-instance",
          "patch": "http://scap.nist.gov/schema/patch/0.1",
          "default": "http://scap.nist.gov/schema/feed/vulnerability/2.0",
          "cpe-lang": "http://cpe.mitre.org/language/2.0"
    }


    def __init__(self, ignore_before_date=None):
        self.cve_list = []
        self.ignore_before_date = ignore_before_date

    def parse(self, filename):
        tree = etree.parse(filename)
        root = tree.getroot()
        for entry in root.findall("default:entry", CveXmlParser.NS):
            cve = {}
            cve["cveid"] = entry.find("vuln:cve-id", CveXmlParser.NS).text
            cve["summary"] = entry.find("vuln:summary", CveXmlParser.NS).text

            try:
                cve["cwe"] = entry.find("vuln:cwe", CveXmlParser.NS).get("id")
            except AttributeError:
                cve["cwe"] = ""
                pass

            cve["published_date"] = parse_date(entry.find("vuln:published-datetime", CveXmlParser.NS).text)
            cve["modified_date"] = parse_date(entry.find("vuln:last-modified-datetime", CveXmlParser.NS).text)

            if self.ignore_before_date and cve["modified_date"] < self.ignore_before_date:
                continue

            try:
                cvss_base = entry.find("vuln:cvss", CveXmlParser.NS).find("cvss:base_metrics", CveXmlParser.NS)
                cve["cvss_score"] = cvss_base.find("cvss:score", CveXmlParser.NS).text

                cve["cvss"] = "/".join("%s:%s" % (k,cvss_base.find("cvss:%s" % k, CveXmlParser.NS).text)
                                       for k in ["access-vector", "access-complexity",
                                                 "authentication", "confidentiality-impact",
                                                 "integrity-impact", "availability-impact"])
            except AttributeError:
                cve["cvss_score"] = "-1"
                cve["cvss"] = ""

            try:
                cpes = []
                for cpe in entry.find("vuln:vulnerable-software-list", CveXmlParser.NS).findall("vuln:product", CveXmlParser.NS):
                    cpes.append(cpe.text)
                cve["cpes"] = cpes
            except AttributeError:
                cve["cpes"] = ""

            self.cve_list.append(cve)

        return self.cve_list


