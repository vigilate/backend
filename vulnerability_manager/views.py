from django.shortcuts import render
from django.http import HttpResponse, HttpResponseServerError
from vulnerability_manager.models import Cpe
from vulnerability_manager import cpe_updater
import requests

def update_cpe(request):
    try:
        cpes = cpe_updater.do_update()
    except requests.RequestException as e:
        return HttpResponseServerError
    cpe_to_save = []
    for cpe in cpes:
        #cpe already exist
        if len(Cpe.objects.filter(cpe = cpe)):
            continue
        parts = cpe.split(':')
        if parts[1] == '/h':
            continue
        new_cpe = Cpe(cpe=cpe, vendor=parts[2], product=parts[3], version = parts[4])
        cpe_to_save.append(new_cpe)
    Cpe.objects.bulk_create(cpe_to_save)
    return HttpResponse(status=200)
