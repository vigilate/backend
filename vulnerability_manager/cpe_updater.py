import requests
import xml.etree.ElementTree as etree
from vulnerability_manager.models import Cpe

xml_url = "http://static.nvd.nist.gov/feeds/xml/cpe/dictionary/official-cpe-dictionary_v2.3.xml"

def do_update():
    r = requests.get(xml_url)

    # raise exception is return code != 200
    r.raise_for_status()

    cpes = []
    root = etree.fromstring(r.text)
    for child in root:
        if 'cpe-item' in child.tag:
            cpes.append(child.attrib['name'])

    return cpes

def get_cpe_from_cpe(cpe_ask):
    cpe = Cpe.objects.filter(cpe = cpe_ask)
    if not cpe:
        parts = cpe_ask.split(':')
        cpe = Cpe(cpe=cpe_ask, vendor=parts[2], product=parts[3], version = parts[4])
        cpe.save()

    return cpe
